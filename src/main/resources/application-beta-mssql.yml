# ── SichrPlace — Beta MSSQL Profile ──
# Activate via environment: SPRING_PROFILES_ACTIVE=beta-mssql
#
# Points Spring Boot at the MSSQL container running on the DigitalOcean
# droplet.  ALL credentials come from environment variables.
#
# On the droplet, set these in /opt/sichrplace/.env:
#   BETA_DB_USER=sichrplace_user
#   BETA_DB_PASS=<generated password>
#   JWT_SECRET=<generated secret>
#
# Or if running inside docker-compose.mssql.yml, environment vars are
# injected automatically from the .env file.

spring:
  datasource:
    url: jdbc:sqlserver://${STAGING_DB_HOST:${BETA_DB_HOST:database}}:${STAGING_DB_PORT:1433};databaseName=${STAGING_DB_NAME:sichrplace};encrypt=${STAGING_DB_ENCRYPT:true};trustServerCertificate=${STAGING_DB_TRUST_SERVER_CERTIFICATE:false};loginTimeout=30;socketTimeout=30
    username: ${STAGING_DB_USER:${BETA_DB_USER}}
    password: ${STAGING_DB_PASS:${BETA_DB_PASS}}
    driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
    hikari:
      pool-name: SichrPlace-MSSQL-Beta
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      validation-timeout: 5000
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
  jpa:
    hibernate:
      ddl-auto: validate          # Schema managed by migration scripts; Hibernate validates only
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.SQLServerDialect

server:
  port: ${PORT:8080}

app:
  jwtSecret: ${JWT_SECRET}
  jwtExpirationMs: ${JWT_EXPIRATION:86400000}
  jwtRefreshExpirationMs: ${JWT_REFRESH_EXPIRATION:604800000}

  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:https://sichrplace.com,https://www.sichrplace.com}

  email:
    provider: ${EMAIL_PROVIDER:smtp}
    from: ${EMAIL_FROM:noreply@sichrplace.de}

  login:
    maxFailedAttempts: ${LOGIN_MAX_FAILED_ATTEMPTS:5}
    lockoutMinutes: ${LOGIN_LOCKOUT_MINUTES:30}

  # Optional: previous JWT secret kept during key-rotation grace period
  jwtSecretPrevious: ${JWT_SECRET_PREVIOUS:}

  refreshTokenExpirationDays: ${REFRESH_TOKEN_EXPIRATION_DAYS:14}

  ratelimit:
    capacity: ${RATE_LIMIT_CAPACITY:10}
    refillTokens: ${RATE_LIMIT_REFILL_TOKENS:10}
    refillSeconds: ${RATE_LIMIT_REFILL_SECONDS:60}

spring:
  mail:
    host: ${SMTP_HOST}
    port: ${SMTP_PORT:587}
    username: ${SMTP_USER}
    password: ${SMTP_PASS}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true

# ── Teaching note ──
# Students: This profile is identical in structure to application-local-mssql.yml
# but uses BETA_DB_* env vars and points at a remote host instead of localhost.
# The JDBC URL, driver, and Hibernate dialect are the same — only the host changes.
#
# Compare the two files side-by-side:
#   local-mssql → localhost:1433          (your laptop)
#   beta-mssql  → ${BETA_DB_HOST}:1433   (DigitalOcean droplet)
#
# Question: Why does the beta profile have NO default values for username/password?
